<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>WebRTC Voice (Manual Signaling)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light dark; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; line-height: 1.4; }
    h1 { margin: 0 0 8px; font-size: 20px; }
    h2 { margin: 20px 0 8px; font-size: 16px; }
    .card { border: 1px solid rgba(0,0,0,.15); border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    textarea, input[type=text] { width: 100%; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    textarea { min-height: 140px; resize: vertical; }
    button { padding: 8px 12px; border-radius: 10px; border: 1px solid rgba(0,0,0,.2); cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .muted { opacity: .8; font-size: 12px; }
    .good { color: #0a7a0a; }
    .bad { color: #b00020; }
    .log { font-family: ui-monospace, monospace; white-space: pre-wrap; max-height: 220px; overflow: auto; background: rgba(0,0,0,.04); padding: 8px; border-radius: 8px; }
    .cols { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 900px) { .cols { grid-template-columns: 1fr 1fr; } }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; background: rgba(0,0,0,.08); font-size: 12px; margin-left: 6px; }
    .audio-wrap { display: flex; gap: 12px; align-items: center; }
    .small { font-size: 12px; }
  </style>
</head>
<body>
  <h1>WebRTC Voice (Manual Copy-Paste Signaling)</h1>
  <p class="muted">
    Open this page in <b>two tabs</b>. In Tab A click <b>Create Offer</b>, copy the SDP below into Tab B’s “Remote Offer”, then click <b>Create Answer</b> in Tab B and copy the answer back into Tab A’s “Remote Answer”.<br/>
    This uses <b>non-trickle ICE</b>: we wait until all ICE candidates are gathered before showing the SDP fields, so no separate candidate exchange is needed.
  </p>

  <div class="card">
    <h2>1) Microphone</h2>
    <div class="row">
      <button id="btnMic">Enable Microphone</button>
      <span id="micStatus" class="pill">mic: off</span>
    </div>
    <div class="audio-wrap" style="margin-top:10px">
      <audio id="localAudio" autoplay muted></audio>
      <span class="small muted">Local mic (muted locally)</span>
    </div>
    <div class="audio-wrap" style="margin-top:10px">
      <audio id="remoteAudio" autoplay playsinline></audio>
      <span class="small muted">Remote audio</span>
    </div>
  </div>

  <div class="cols">
    <div class="card">
      <h2>2) Offerer (Tab A)</h2>
      <div class="row">
        <button id="btnCreateOffer" disabled>Create Offer</button>
        <span id="offerState" class="pill">idle</span>
      </div>
      <p class="muted small">After clicking <b>Create Offer</b>, wait until ICE says <b>complete</b>, then copy the “Your Offer (Local)” SDP to Tab B.</p>
      <label class="small">Your Offer (Local) — copy this to Tab B</label>
      <textarea id="localOffer" readonly placeholder="Click ‘Create Offer’ first..."></textarea>

      <label class="small">Remote Answer (from Tab B) — paste here, then click “Apply Answer”</label>
      <textarea id="remoteAnswer" placeholder="Paste answer from Tab B here..."></textarea>
      <div class="row">
        <button id="btnApplyAnswer" disabled>Apply Answer</button>
        <span id="applyAnswerState" class="pill">waiting</span>
      </div>
    </div>

    <div class="card">
      <h2>3) Answerer (Tab B)</h2>
      <p class="muted small">In Tab B, paste Tab A’s offer into “Remote Offer”, click <b>Create Answer</b>, wait for ICE to complete, then copy “Your Answer (Local)” back to Tab A.</p>
      <label class="small">Remote Offer (from Tab A) — paste here, then click “Create Answer”</label>
      <textarea id="remoteOffer" placeholder="Paste offer from Tab A here..."></textarea>
      <div class="row">
        <button id="btnCreateAnswer" disabled>Create Answer</button>
        <span id="answerState" class="pill">idle</span>
      </div>
      <label class="small">Your Answer (Local) — copy this to Tab A</label>
      <textarea id="localAnswer" readonly placeholder="Will appear after ‘Create Answer’..."></textarea>
    </div>
  </div>

  <div class="card">
    <h2>Debug & Status</h2>
    <div class="row small">
      <div>PC: <span id="pcState" class="pill">new</span></div>
      <div>ICE: <span id="iceState" class="pill">new</span></div>
      <div>ICE Gathering: <span id="gathState" class="pill">new</span></div>
      <div>Signaling: <span id="sigState" class="pill">stable</span></div>
      <div>Conn: <span id="connState" class="pill">new</span></div>
    </div>
    <pre class="log" id="log"></pre>
  </div>

  <script>
    // --------- Helpers ---------
    const $ = (id) => document.getElementById(id);
    const log = (...args) => {
      const s = args.map(a => (typeof a === 'object' ? JSON.stringify(a, null, 2) : String(a))).join(' ');
      $("log").textContent += s + "\n";
      $("log").scrollTop = $("log").scrollHeight;
      console.log(...args);
    };
    const setText = (id, text) => { $(id).textContent = text; };

    // --------- Elements ---------
    const btnMic = $("btnMic");
    const micStatus = $("micStatus");
    const localAudio = $("localAudio");
    const remoteAudio = $("remoteAudio");

    const btnCreateOffer = $("btnCreateOffer");
    const offerState = $("offerState");
    const localOffer = $("localOffer");
    const remoteAnswer = $("remoteAnswer");
    const btnApplyAnswer = $("btnApplyAnswer");
    const applyAnswerState = $("applyAnswerState");

    const remoteOffer = $("remoteOffer");
    const btnCreateAnswer = $("btnCreateAnswer");
    const answerState = $("answerState");
    const localAnswer = $("localAnswer");

    const pcState = $("pcState");
    const iceState = $("iceState");
    const gathState = $("gathState");
    const sigState = $("sigState");
    const connState = $("connState");

    // --------- WebRTC Globals ---------
    let pc;
    let localStream;
    let isOfferer = false;

    function makePeerConnection() {
      // Create RTCPeerConnection with a public STUN server
      pc = new RTCPeerConnection({
        iceServers: [{ urls: ["stun:stun.l.google.com:19302"] }]
      });

      // Status hooks
      pc.oniceconnectionstatechange = () => {
        setText("iceState", pc.iceConnectionState);
        log("ICE connection state:", pc.iceConnectionState);
      };
      pc.onicegatheringstatechange = () => {
        setText("gathState", pc.iceGatheringState);
        log("ICE gathering state:", pc.iceGatheringState);

        // When gathering completes, expose the full SDP for copy-paste
        if (pc.iceGatheringState === "complete") {
          if (isOfferer) {
            localOffer.value = JSON.stringify(pc.localDescription);
          } else {
            localAnswer.value = JSON.stringify(pc.localDescription);
          }
        }
      };
      pc.onsignalingstatechange = () => {
        setText("sigState", pc.signalingState);
        log("Signaling state:", pc.signalingState);
      };
      pc.onconnectionstatechange = () => {
        setText("connState", pc.connectionState);
        log("Peer connection state:", pc.connectionState);
      };
      pc.onicecandidateerror = (e) => {
        log("ICE candidate error:", e.errorText || e);
      };
      pc.ontrack = (ev) => {
        log("ontrack: received remote track(s). Streams:", ev.streams.length);
        // Attach the first stream to the remote audio element
        if (ev.streams && ev.streams[0]) {
          remoteAudio.srcObject = ev.streams[0];
        } else {
          // Fallback: construct a MediaStream
          const inbound = new MediaStream([ev.track]);
          remoteAudio.srcObject = inbound;
        }
      };

      setText("pcState", "created");
    }

    async function ensureMic() {
      if (localStream) return localStream;
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
        localAudio.srcObject = localStream;
        micStatus.textContent = "mic: on";
        micStatus.classList.add("good");
        log("Microphone enabled.");
        // Create PC if not exists and add tracks
        if (!pc) makePeerConnection();
        localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
        // Enable UI actions
        btnCreateOffer.disabled = false;
        btnCreateAnswer.disabled = false;
        return localStream;
      } catch (err) {
        micStatus.textContent = "mic: error";
        micStatus.classList.add("bad");
        log("getUserMedia error:", err);
        throw err;
      }
    }

    // --------- Offerer Flow (Tab A) ---------
    btnMic.onclick = async () => {
      btnMic.disabled = true;
      try { await ensureMic(); } finally { btnMic.disabled = false; }
    };

    btnCreateOffer.onclick = async () => {
      try {
        await ensureMic();
        if (!pc) makePeerConnection();
        isOfferer = true;
        offerState.textContent = "creating...";
        const offer = await pc.createOffer({
          offerToReceiveAudio: true,
          offerToReceiveVideo: false
        });
        await pc.setLocalDescription(offer);
        offerState.textContent = "gathering ICE... (wait)";
        // We will fill localOffer textarea when gathering completes (see onicegatheringstatechange)
        log("Offer created. Waiting for ICE to complete...");
      } catch (err) {
        offerState.textContent = "error";
        log("Create offer error:", err);
      } finally {
        btnApplyAnswer.disabled = false;
      }
    };

    btnApplyAnswer.onclick = async () => {
      try {
        applyAnswerState.textContent = "applying...";
        const answer = JSON.parse(remoteAnswer.value.trim());
        await pc.setRemoteDescription(answer);
        applyAnswerState.textContent = "applied";
        applyAnswerState.classList.add("good");
        log("Remote answer applied.");
      } catch (err) {
        applyAnswerState.textContent = "error";
        applyAnswerState.classList.add("bad");
        log("Apply answer error:", err);
      }
    };

    // --------- Answerer Flow (Tab B) ---------
    btnCreateAnswer.onclick = async () => {
      try {
        await ensureMic();
        if (!pc) makePeerConnection();
        isOfferer = false;
        answerState.textContent = "parsing offer...";
        const offer = JSON.parse(remoteOffer.value.trim());
        await pc.setRemoteDescription(offer);
        answerState.textContent = "creating answer...";
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        answerState.textContent = "gathering ICE... (wait)";
        log("Answer created. Waiting for ICE to complete...");
        // localAnswer gets populated on ICE gathering complete
      } catch (err) {
        answerState.textContent = "error";
        log("Create answer error:", err);
      }
    };

    // --------- Auto-init -------
    (function init() {
      // Create PC eagerly so state pills show transitions even before mic
      makePeerConnection();
      log("Ready. 1) Click ‘Enable Microphone’. 2) In one tab click ‘Create Offer’. 3) Copy/paste SDPs between tabs.");
    })();
  </script>
</body>
</html>
