<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Caller A</title>
</head>
<body>
  <h1>Caller A</h1>
  <audio id="remoteAudio" autoplay></audio>
  <script>
    const id = "a"; // Caller A id
    const remoteId = "b"; // Talking to Caller B

    const pc = new RTCPeerConnection({
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    });

    // Debug logs
    pc.oniceconnectionstatechange = () => console.log("ICE state:", pc.iceConnectionState);
    pc.onconnectionstatechange = () => console.log("Peer state:", pc.connectionState);

    // Play remote audio
    pc.ontrack = event => {
      console.log("Got remote track:", event.streams);
      document.getElementById("remoteAudio").srcObject = event.streams[0];
    };

    // Send ICE candidates to backend
    pc.onicecandidate = event => {
      if (event.candidate) {
        console.log("Sending candidate:", event.candidate);
        fetch(`http://localhost:8080/candidate/${id}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(event.candidate.toJSON())
        });
      }
    };

    async function start() {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      stream.getTracks().forEach(track => pc.addTrack(track, stream));

      // Create SDP offer
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      console.log("Sending offer:", offer);

      // Send to backend
      const res = await fetch(`http://localhost:8080/offer/${id}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(offer)
      });
      const answer = await res.json();
      console.log("Got answer:", answer);
      await pc.setRemoteDescription(answer);

      // Poll for remote ICE candidates
      pollCandidates();
    }

    async function pollCandidates() {
      setInterval(async () => {
        const res = await fetch(`http://localhost:8080/candidate/${remoteId}`);
        if (res.ok) {
          const candidates = await res.json();
          for (const c of candidates) {
            console.log("Adding remote candidate:", c);
            try {
              await pc.addIceCandidate(c);
            } catch (err) {
              console.error("Error adding candidate:", err);
            }
          }
        }
      }, 2000);
    }

    start();
  </script>
</body>
</html>
